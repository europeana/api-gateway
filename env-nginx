#!/bin/bash

# Substitute env var strings in NGINX config with values from env

export USE_EPOLL='use epoll'
export WORKER_CONNECTIONS=1024
export PORT='80'
export PUBLIC_FOLDER='/usr/share/nginx/html'

# Also use default nameserver for resolving hostnames (necessary for k8s deployments so we can use service names)
NAMESERVER=$(cat /etc/resolv.conf | grep "nameserver" | awk '{print $2}' | tr '\n' ' ')
export RESOLVER_SETTINGS="${NAMESERVER} ${RESOLVER_SETTINGS}"

vars='$ANNOTATION_API_HOST
      $DOCS_ATLASSIAN
      $DOC_SEARCH
      $DOC_RECORD
      $EMBEDDING_API_HOST
      $EMBEDDING_SERVER1_SETTINGS
      $EMBEDDING_SERVER2_SETTINGS
      $ENTITY_API_HOST
      $ENTITY_MANAGEMENT_HOST
      $FULLTEXT_API_HOST
      $KEYCLOAK_HOST
      $MANIFEST_API_HOST
      $NEWSPAPER_API_HOST
      $OAI_RECORD_HOST
      $OAI_SERVER_NEW
      $OAI_SERVER_OLD
      $RECOMMENDATION_API_HOST
      $RESOLVER_SETTINGS
      $ROOT_REDIRECT_HOST
      $SEARCH_API_HOST
      $SET_API_HOST
      $SPARQL_API_HOST
      $SPARQL_API_SERVER1_SETTINGS
      $SPARQL_API_SERVER2_SETTINGS
      $SPARQL_SERVER_NEW
      $SPARQL_SERVER_OLD
      $SPARQL_UI_HOST
      $THUMBNAIL_API_HOST
      $TRANSLATION_API_HOST
      $USE_EPOLL
      $WORKER_CONNECTIONS
      $PORT
      $PUBLIC_FOLDER'

envsubst "${vars}" < /etc/nginx/nginx.conf.template > /etc/nginx/nginx.conf

if [ -z "$1" ]; then
      echo "No parameters given, running nginx."
      nginx
else
      echo "Executing $@"
      exec "$@"
fi
