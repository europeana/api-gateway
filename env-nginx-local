#!/bin/bash

# Substitute env var strings in NGINX config with values from env.
# This version is to facilitate local testing because epoll did not work there and too many worker connections,
# and manually editing and reverting them was very tedious.
# It works on Mac OS in any case, likely also on Linux but check PORT and ROOT

export ANNOTATION_API_HOST=annotation-api-production.eanadev.org
export EMBEDDING_API_HOST=embedding-api.test.eanadev.org
export EMBEDDING_SERVER1_SETTINGS='rec-engine-test.eanadev.org max_fails=1 fail_timeout=60s'
export EMBEDDING_SERVER2_SETTINGS='rec-engine-acc.eanadev.org max_fails=1 fail_timeout=60s down'
export ENTITY_API_HOST=entity-api-v2-production.eanadev.org
export ENTITY_MANAGEMENT_HOST=entity-management-production.eanadev.org
export FULLTEXT_API_HOST=iiif-api.eanadev.org
export KEYCLOAK_HOST=keycloak.test.eanadev.org
export MANIFEST_API_HOST=iiif-api.eanadev.org
export NEWSPAPER_API_HOST=newspapers.eanadev.org
export OAI_RECORD_HOST=oai-pmh.europeana.eu
export RECOMMENDATION_API_HOST=recommend-api.eanadev.org
export ROOT_REDIRECT_URL=https://pro.europeana.eu/resources/apis
export SEARCH_API_HOST=search-api.europeana.eu
export SET_API_HOST=set-api.eanadev.org
export THUMBNAIL_API_HOST=thumbnail.eanadev.org
export TRANSLATION_API_HOST=translation-api-production.eanadev.org
export NO_EPOLL='#'
export WORKERCONNECTIONS=256
export PORT='8088'
export ROOT='/usr/local/etc/nginx/public'

# Also use default nameserver for resolving hostnames (necessary for k8s deployments so we can use service names)
NAMESERVER=$(cat /etc/resolv.conf | grep "nameserver" | awk '{print $2}' | tr '\n' ' ')
export RESOLVER_SETTINGS="${NAMESERVER} ${RESOLVER_SETTINGS}"

vars='$ANNOTATION_API_HOST
      $EMBEDDING_API_HOST
      $EMBEDDING_SERVER1_SETTINGS
      $EMBEDDING_SERVER2_SETTINGS
      $ENTITY_API_HOST
      $ENTITY_MANAGEMENT_HOST
      $FULLTEXT_API_HOST
      $KEYCLOAK_HOST
      $MANIFEST_API_HOST
      $NEWSPAPER_API_HOST
      $OAI_RECORD_HOST
      $RECOMMENDATION_API_HOST
      $ROOT_REDIRECT_URL
      $SEARCH_API_HOST
      $SET_API_HOST
      $THUMBNAIL_API_HOST
      $TRANSLATION_API_HOST
      $NO_EPOLL
      $WORKERCONNECTIONS
      $PORT
      $ROOT'

# this version is meant to be run in the local nginx config directory, so omitting paths
envsubst "${vars}" < nginx.conf.template > nginx.conf

if [ -z "$1" ]; then
      echo "No container params"
else
      exec "$@"
fi